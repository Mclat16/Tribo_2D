# LAMMPS input script for system build with input of substrate, graphene sheet and AFM tip

clear

units           metal
atom_style      atomic
neighbor        0.3 bin
neigh_modify    every 1 delay 0 check yes #every 5

boundary   	    p p f
region box block 0.0 95.76714 0.0 99.52413130533705 -5 100
create_box      18 box

#----------------- Read data files -----------------------

read_data       MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/system_build/sub.lmp add append group sub
read_data       MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/system_build/tip.lmp add append shift 47.88357 49.762065652668525 55.0  group tip
read_data       MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/system_build/MoS2_1.lmp add append shift 0.0 0.0 14.459431333333335 group 2D

group type_1 type 1
group type_2 type 2
group type_3 type 3
group type_4 type 4
group type_5 type 5
group type_6 type 6
group type_7 type 7
group type_8 type 8
group type_9 type 9
group type_10 type 10
group type_11 type 11
group type_12 type 12

#Identify the top atoms of AFM tip

region          tip_fix block INF INF INF INF 65.0 INF units box
group           tip_fix region tip_fix

#Identify thermostat region of AFM tip

region          tip_thermo block INF INF INF INF 63.0 65.0 units box
group           tip_thermo region tip_thermo

#Identify bottom atoms of Amorphous Silicon substrate

region          sub_fix block INF INF INF INF INF 2 units box
group           sub_fix region sub_fix

#Identify thermostat region of Amorphous Silicon substrate

region          sub_thermo block INF INF INF INF 2 5 units box
group           sub_thermo region sub_thermo

# Define sub groups and atom types

group sub_1 intersect sub type_1
set group sub_1 type 1
group sub_fix_1 intersect sub_fix type_1
set group sub_fix_1 type 2
group sub_fix_1 delete

group sub_thermo_1 intersect sub_thermo type_1
set group sub_thermo_1 type 3
group sub_thermo_1 delete

group sub_1 delete

group tip_1 intersect tip type_1
set group tip_1 type 4
group tip_fix_1 intersect tip_fix type_1
set group tip_fix_1 type 5
group tip_fix_1 delete

group tip_thermo_1 intersect tip_thermo type_1
set group tip_thermo_1 type 6
group tip_thermo_1 delete

group tip_1 delete

group 2D_1 intersect 2D type_1
set group 2D_1 type 7
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_1 layer_1
set group layer type 8
group layer_1 delete
group layer delete

group 2D_1 delete

group 2D_2 intersect 2D type_2
set group 2D_2 type 9
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_2 layer_1
set group layer type 10
group layer_1 delete
group layer delete

group 2D_2 delete

group 2D_3 intersect 2D type_3
set group 2D_3 type 11
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_3 layer_1
set group layer type 12
group layer_1 delete
group layer delete

group 2D_3 delete

group 2D_4 intersect 2D type_4
set group 2D_4 type 13
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_4 layer_1
set group layer type 14
group layer_1 delete
group layer delete

group 2D_4 delete

group 2D_5 intersect 2D type_5
set group 2D_5 type 15
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_5 layer_1
set group layer type 16
group layer_1 delete
group layer delete

group 2D_5 delete

group 2D_6 intersect 2D type_6
set group 2D_6 type 17
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_6 layer_1
set group layer type 18
group layer_1 delete
group layer delete

group 2D_6 delete

group 2D_7 intersect 2D type_7
set group 2D_7 type 19
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_7 layer_1
set group layer type 20
group layer_1 delete
group layer delete

group 2D_7 delete

group 2D_8 intersect 2D type_8
set group 2D_8 type 21
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_8 layer_1
set group layer type 22
group layer_1 delete
group layer delete

group 2D_8 delete

group 2D_9 intersect 2D type_9
set group 2D_9 type 23
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_9 layer_1
set group layer type 24
group layer_1 delete
group layer delete

group 2D_9 delete

group 2D_10 intersect 2D type_10
set group 2D_10 type 25
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_10 layer_1
set group layer type 26
group layer_1 delete
group layer delete

group 2D_10 delete

group 2D_11 intersect 2D type_11
set group 2D_11 type 27
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_11 layer_1
set group layer type 28
group layer_1 delete
group layer delete

group 2D_11 delete

group 2D_12 intersect 2D type_12
set group 2D_12 type 29
region layer_1 block INF INF INF INF 20.148578333333333 30.148578333333333 units box
group layer_1 region layer_1 
region layer_1 delete
group layer intersect 2D_12 layer_1
set group layer type 30
group layer_1 delete
group layer delete

group 2D_12 delete

# Apply potentials

include        MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/l_1/lammps/system.in.settings

#----------------- Create visualisation files ------------

dump            sys all atom 100 ./MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/visuals/system_1.lammpstrj

#----------------- Minimize the system -------------------

min_style       cg
minimize        1.0e-4 1.0e-8 1000000 1000000

timestep        0.001
thermo          100

group           fixset union sub_fix tip_fix
group           system subtract all fixset

velocity        system create 300 492847948

compute         temp_tip tip_thermo temp/partial 0 1 0
fix             lang_tip tip_thermo langevin 300 300 $(100.0*dt) 699483 zero yes
fix_modify      lang_tip temp temp_tip

compute         temp_sub sub_thermo temp/partial 0 1 0
fix             lang_sub sub_thermo langevin 300 300 $(100.0*dt) 2847563 zero yes
fix_modify      lang_sub temp temp_sub

fix             nve_all all nve

fix             sub_fix sub_fix setforce 0.0 0.0 0.0 
velocity        sub_fix set 0.0 0.0 0.0

fix             tip_f tip_fix rigid/nve single force * off off off torque * off off off

run             10000

unfix           tip_f 

##########################################################
#--------------------Tip Indentation---------------------#
##########################################################
#----------------- Displace tip closer -------------------

displace_atoms  tip_all move 0.0 0.0 -20.0 units box

#----------------- Apply constraints ---------------------

#Fix the bottom layer of the base and the edges of the graphene

fix             tip_f tip_fix rigid/nve single force * off off on torque * off off off

#----------------- Set up initial parameters -------------

                variable find equal 5
variable        num_floads equal 500
variable        r equal 0.0
variable        f equal 0.0
variable        fincr equal ${find}/(${num_floads})
thermo_modify   lost ignore flush yes

#----------------- Apply pressure to the tip -------------

variable i loop ${num_floads}
label loop_load

variable f equal ${f}+${fincr} 

# Set force variable

variable Fatom equal -v_f/(count(tip_fix)*1.602176565)
fix forcetip tip_fix aveforce 0.0 0.0 ${Fatom}
run 100 

unfix forcetip

next i
jump SELF loop_load

##########################################################
#---------------------Equilibration----------------------#
##########################################################

fix forcetip tip_fix aveforce 0.0 0.0 ${Fatom}
variable        dispz equal xcm(tip_fix,z)

run 100 pre yes post no

# Prepare to loop for displacement checks

label check_r

variable disp_l equal ${dispz}
variable disp_h equal ${dispz}

variable disploop loop 50
label disp

run 100 pre no post no

if '${dispz}>${disp_h}' then 'variable disp_h equal ${dispz}'
if '${dispz}<${disp_l}' then 'variable disp_l equal ${dispz}'

next disploop
jump SELF disp

variable r equal ${disp_h}-${disp_l}

# Check if r is less than 0.1

if '${r} < 0.2' then 'jump SELF loop_end' else 'jump SELF check_r'

# End of the loop

label loop_end

write_data MoS2/size_100x_100y/sub_aSi/tip_Si_r25/K300/l_1/data/load_5N.data